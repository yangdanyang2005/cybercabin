<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>魂入华夏</title>
    <link rel="icon" href="favicon.png" type="image/png" />

    <style>
        /* ==========================================================
           1) 全局变量与基础样式
           ========================================================== */
        @font-face {
            font-family: 'AncientFont';
            src: local('KaiTi'), local('STKaiti'), local('SimSun'), serif;
        }

        :root{
            --stage-bg:#1a1a1a;

            --ink-1:#110e0e;
            --ink-2:#1f1a1a;
            --ink-3:#2a2020;

            --gold:#8b5a2b;
            --gold-deep:#5c4033;
            --gold-light:#d0b090;

            --paper:#e0d0b0;
            --accent:#ffb366;

            --ink-light-1:#2b2b2b;
            --ink-light-2:#3a3a3a;
        }

        body{
            background-color: var(--stage-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'AncientFont', serif;
            overflow: hidden;
            user-select: none;
        }

        /* ==========================================================
           2) 游戏舞台
           ========================================================== */
        #game-stage{
            width: 960px;
            height: 640px;
            background-color: #000;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            border: 4px double var(--gold-deep);
            overflow: hidden;
        }

        /* ==========================================================
           3) 背景层（双层交替淡入）
           ========================================================== */
        .bg-layer{
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            z-index: 1;
        }
        .bg-layer.active{
            opacity: 1;
            z-index: 2;
        }

        /* ==========================================================
           4) 立绘层
           ========================================================== */
        #character-layer{
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 440px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center bottom;
            transform: scale(0.95);
            transition: opacity 0.3s;
            z-index: 5;
            pointer-events: none;
        }

        /* ==========================================================
           5) 对话 UI 容器
           ========================================================== */
        #ui-container{
            position: absolute;
            bottom: 0; left: 0;
            width: 100%;
            height: 200px;
            z-index: 10;
            display: none;
            overflow: visible;
        }

        /* ==========================================================
           6) 头像组件（双层交替淡入）
           ========================================================== */
        #avatar-box{
            position: absolute;
            bottom: 50px; left: 10px;
            width: 220px;
            height: 220px;
            z-index: 100;
            pointer-events: none;
        }
        .avatar-layer{
            position: absolute;
            bottom: 0; left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: bottom center;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            filter: drop-shadow(5px 5px 8px rgba(0,0,0,0.6));
        }
        .avatar-layer.active{ opacity: 1; }

        /* ==========================================================
           7) 对话框组件
           ========================================================== */
        #text-box{
            position: absolute;
            bottom: 0; left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, var(--ink-2), var(--ink-1));
            border-top: 4px solid var(--gold);
            padding: 35px 40px 35px 240px;
            box-sizing: border-box;
            color: var(--paper);
            cursor: pointer;
            pointer-events: auto;
            z-index: 10;
        }

        #name-tag{
            font-size: 28px;
            font-weight: bold;
            color: var(--accent);
            text-shadow: 2px 2px 4px #000;
            margin-bottom: 15px;
            letter-spacing: 2px;
            display: inline-block;
            border-bottom: 2px solid #5c2020;
            padding-bottom: 4px;
        }

        #dialog-text{
            font-size: 22px;
            line-height: 1.6;
            letter-spacing: 1.5px;
            text-shadow: 1px 1px 2px #000;
        }

        #next-indicator{
            position: absolute;
            bottom: 20px;
            right: 30px;
            font-size: 16px;
            color: var(--gold);
            animation: pulse 1.5s infinite;
        }

        /* ==========================================================
           8) 全屏覆盖层：通用布局（封面/结尾/回响/首页）
           ========================================================== */
        .full-screen-layer{
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            z-index: 2000;
            background: #000;
        }

        /* 顶部视觉区：flex: 1 会自动占据剩余空间，底部变高后它会自动变矮 */
        .top-visual-area{
            flex: 1;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        /* 顶部视觉区暗角：提升标题对比度但不发黑 */
        .top-visual-area::after{
            content:"";
            position:absolute;
            inset:0;
            background:
                radial-gradient(ellipse at center, rgba(0,0,0,0.04) 0%, rgba(0,0,0,0.16) 70%, rgba(0,0,0,0.24) 100%),
                linear-gradient(to bottom, rgba(0,0,0,0.05), rgba(0,0,0,0.10));
            pointer-events:none;
        }

        /* 统一底部文字区：用于封面页/结尾页 */
        .bottom-text-area{
            height: 220px;
            box-sizing: border-box;
            border-top: 4px solid var(--gold);
            display: flex;
            flex-direction: column;
            align-items: center;          /* 横向居中 */
            justify-content: center;      /* 纵向居中 */
            text-align: center;
            padding: 10px 40px;
            gap: 8px;
            position: relative;
        }

        /* 页面遮罩：用于顶部视觉区的统一轻遮罩 */
        .screen-overlay{
            position:absolute;
            inset:0;
            background: rgba(0,0,0,0.12);
            z-index: 6;
            pointer-events:none;
        }

        /* 封面/结尾：遮罩仅覆盖顶部视觉区高度 */
        #chapter-cover-screen .screen-overlay,
        #end-screen .screen-overlay{
            height: 420px;
            bottom: auto;
        }

        /* 首页遮罩覆盖全屏 */
        #start-screen .screen-overlay{ height: 100%; }

        /* 首页背景更亮一点，减少“黑纱”感 */
        #start-bg-layer{ opacity: 0.82; }

        /* ==========================================================
           9) 标题组件（封面与结尾共用）
           ========================================================== */
        .screen-title{
            position: relative;
            padding: 6px 18px;
            border: 2px solid rgba(208,176,144,0.35);
            border-left: 6px solid var(--gold);
            background: rgba(0,0,0,0.25);
            box-shadow: 0 0 18px rgba(139,90,43,0.25);
            border-radius: 2px;

            font-size: 44px;
            color: var(--accent);
            letter-spacing: 6px;
            font-weight: bold;
            text-shadow: 0 0 10px #8b4513;
            margin: 0;
        }

        #chapter-cover-screen .screen-title,
        #end-screen .screen-title{
            border: none;
            background: none;
            box-shadow: none;
            padding: 0;
        }

        /* 针对结尾页按钮的特定样式 */
        #end-screen .menu-btn {
            min-width: 160px;
        }

        .screen-subtitle{
            font-size: 18px;
            color: #aaa;
            letter-spacing: 2px;
            font-style: normal;
            opacity: 0.95;
            line-height: 1.5;
            margin: 0;
            padding: 0 60px;
        }

        .cover-ornament{
            width: 72%;
            height: 6px;
            margin: 1px 0 1px;
            position: relative;
            opacity: 0.85;
            background-image: radial-gradient(circle, rgba(255,200,140,0.9) 0 2px,
        rgba(0,0,0,0) 3px);
            background-repeat: no-repeat;
            background-position: center;
        }
        .cover-ornament::before,
        .cover-ornament::after{
            content:"";
            position:absolute;
            top: 50%;
            width: calc(50% - 16px);
            height: 1px;
            background: rgba(255,210,160,0.7);
            transform: translateY(-50%);
        }
        .cover-ornament::before{ left:0; }
        .cover-ornament::after{ right:0; }

        .action-buttons{
            display: flex;
            justify-content: center;   /* 按钮组整体居中 */
            align-items: center;
            gap: 18px;                 /* 两个按钮之间的间距 */
            width: 100%;
            margin-top: 2px;
        }

        .hint-text{
            font-size: 14px;
            color: var(--gold);
            letter-spacing: 2px;
            opacity: 0.9;
            margin-top: 4px;
            animation: pulse 1.6s infinite;
            text-shadow: 0 0 6px rgba(139,90,43,0.35);
        }

        /* 封面/结尾底部背景统一（纹理一致） */
        #chapter-cover-screen .bottom-text-area,
        #end-screen .bottom-text-area{
            background:
                linear-gradient(to bottom, var(--ink-2), var(--ink-1)),
                repeating-linear-gradient(135deg,
                    rgba(255,255,255,0.03) 0,
                    rgba(255,255,255,0.03) 6px,
                    rgba(0,0,0,0) 6px,
                    rgba(0,0,0,0) 14px
                );
        }

        /* ==========================================================
           10) 首页
           ========================================================== */
        #start-screen{
            cursor: default;
            transition: opacity 1s;
        }

        #start-content-wrapper{
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            width: 100%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #start-title{
            font-size: 56px;
            margin-bottom: 10px;
            color: var(--accent);
            letter-spacing: 10px;
            font-weight: bold;
            text-shadow: 0 0 10px #8b4513;
        }

        #start-info{
            font-size: 20px;
            color: #ccc;
            letter-spacing: 2px;
            margin-bottom: 30px;
        }

        /* 章节选择列表 */
        #chapter-list-container{
            width: 60%;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--gold) var(--stage-bg);
        }
        #chapter-list-container::-webkit-scrollbar{ width: 8px; }
        #chapter-list-container::-webkit-scrollbar-track{ background: var(--stage-bg); }
        #chapter-list-container::-webkit-scrollbar-thumb{
            background-color: var(--gold);
            border-radius: 4px;
        }

        .chapter-card{
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--gold-deep);
            border-left: 4px solid var(--gold);
            padding: 15px 20px;
            margin-bottom: 15px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chapter-card:hover{
            background: rgba(139, 90, 43, 0.2);
            border-color: var(--gold-light);
            transform: translateX(5px);
        }

        .chapter-title{
            font-size: 22px;
            color: var(--paper);
            font-weight: bold;
            letter-spacing: 1px;
        }
        .chapter-subtitle{
            font-size: 16px;
            color: #888;
            margin-top: 5px;
            font-style: italic;
        }
        .chapter-arrow{
            font-size: 20px;
            color: var(--gold-deep);
        }

        /* ==========================================================
           11) 通用按钮
           ========================================================== */
        .menu-btn{
            background: transparent;
            border: 2px solid var(--gold);
            color: var(--gold-light);
            padding: 10px 40px;
            font-family: 'AncientFont', serif;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }
        .menu-btn:hover{
            background: rgba(139, 90, 43, 0.3);
            color: #fff;
            box-shadow: 0 0 15px var(--gold);
        }
        .menu-btn::before{
            content: "◆";
            margin-right: 8px;
            font-size: 14px;
            opacity: 0.6;
        }

        /* ==========================================================
           12) 章节封面页 / 结尾页
           ========================================================== */
        #chapter-cover-screen{
            display: none;
            opacity: 0;
            transition: opacity 1s;
            z-index: 1600;
            cursor: default;
        }

        #end-screen{
            display: none;
            opacity: 0;
            transition: opacity 2s;
            z-index: 1500;
        }

        /* ==========================================================
           13) 回响页（Echo）
           ========================================================== */
        #echo-screen{
            display: none;
            z-index: 3000;
        }

        #echo-visual{
            flex: 1;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        #echo-subtitle-box{
            height: 200px;
            background: linear-gradient(to bottom, var(--ink-2), var(--ink-1));
            border-top: 4px solid var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 60px;
            position: relative;
            box-sizing: border-box;
        }

        #echo-text{
            color: var(--paper);
            font-size: 22px;
            line-height: 1.6;
            letter-spacing: 1.5px;
            text-shadow: 1px 1px 2px #000;
            text-align: center;
        }

        .echo-nav-btn{
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            color: #b09070;
            border: 1px solid var(--gold-deep);
            font-size: 24px;
            padding: 10px 15px;
            cursor: pointer;
            transition: 0.2s;
            z-index: 100;
        }
        .echo-nav-btn:hover{
            background: #3a2a2a;
            color: #fff;
        }
        #echo-prev{ left: 20px; }
        #echo-next{ right: 20px; }

        #echo-close{
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.6);
            border: 1px solid var(--gold);
            color: var(--gold-light);
            padding: 5px 15px;
            cursor: pointer;
            z-index: 110;
        }

        /* ==========================================================
           14) 返回首页按钮（右上角）
           ========================================================== */
        #home-btn{
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--gold);
            color: var(--gold-light);
            padding: 8px 15px;
            font-family: 'AncientFont', serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
        }
        #home-btn:hover{
            background: #3a2a2a;
            color: #fff;
            box-shadow: 0 0 10px var(--gold);
        }

        @keyframes pulse{
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
    </style>
</head>

<body>
    <div id="game-stage">
        <!-- 双背景层：用于交替淡入淡出 -->
        <div id="bg-layer-1" class="bg-layer active"></div>
        <div id="bg-layer-2" class="bg-layer"></div>

        <!-- 立绘层 -->
        <div id="character-layer"></div>

        <!-- 右上角返回首页 -->
        <button id="home-btn" onclick="returnToTitle()">☖ 返回主页</button>

        <!-- 对话 UI -->
        <div id="ui-container">
            <div id="avatar-box">
                <img id="avatar-1" class="avatar-layer" src="" alt="" />
                <img id="avatar-2" class="avatar-layer" src="" alt="" />
            </div>

            <div id="text-box" onclick="nextStep()">
                <div id="name-tag"></div>
                <div id="dialog-text"></div>
                <div id="next-indicator">▼</div>
            </div>
        </div>

        <!-- 首页 -->
        <div id="start-screen" class="full-screen-layer">
            <div id="start-bg-layer" class="bg-layer active"></div>
            <div class="screen-overlay"></div>

            <div id="start-content-wrapper">
                <div id="start-title">当朝二圣</div>
                <div id="start-info">选择一段记忆以开始</div>

                <div id="chapter-list-container">
                    <div style="color:#666; margin-top:20px;">正在读取记忆索引...</div>
                </div>

                <div style="margin-top: 30px;">
                    <button class="menu-btn" onclick="openEchoMode('start')">聆听回响</button>
                </div>
            </div>
        </div>

        <!-- 章节封面 -->
        <div id="chapter-cover-screen" class="full-screen-layer">
            <div id="chapter-cover-bg" class="top-visual-area"></div>
            <div class="screen-overlay"></div>

            <div class="bottom-text-area">
                <div id="chapter-cover-title" class="screen-title"></div>
                <div id="chapter-cover-subtitle" class="screen-subtitle"></div>
                <div class="cover-ornament" aria-hidden="true"></div>

                <div class="action-buttons">
                    <button class="menu-btn" onclick="returnToTitle()">返回首页</button>
                    <button class="menu-btn" onclick="startChapterFromCover()">开始故事</button>
                </div>

                <div class="hint-text">按 Enter 或 “ → / ↓ ” 开始</div>
            </div>
        </div>

        <!-- 结尾页 -->
        <div id="end-screen" class="full-screen-layer">
            <div id="end-bg-layer" class="top-visual-area"></div>
            <div class="screen-overlay"></div>

            <div class="bottom-text-area">
                <div id="end-title" class="screen-title">全剧终</div>
                <div id="end-subtitle" class="screen-subtitle"></div>
                <div class="cover-ornament" aria-hidden="true"></div>

                <div class="action-buttons">
                    <button class="menu-btn" onclick="returnToTitle()">返回首页</button>
                    <button class="menu-btn" onclick="openEchoMode('end')">聆听回响</button>
                </div>
            </div>
        </div>

        <!-- 回响页 -->
        <div id="echo-screen" class="full-screen-layer">
            <button id="echo-close" onclick="closeEchoMode()">✕ 返回</button>

            <div id="echo-visual">
                <button id="echo-prev" class="echo-nav-btn" onclick="changeEcho(-1)">❮</button>
                <button id="echo-next" class="echo-nav-btn" onclick="changeEcho(1)">❯</button>
            </div>

            <div id="echo-subtitle-box">
                <div id="echo-text"></div>
            </div>
        </div>

        <!-- 音频播放器：背景音乐与语音分别控制 -->
        <audio id="bgm-player" loop></audio>
        <audio id="voice-player"></audio>
    </div>

    <script>
        /* ==========================================================
           A) 全局状态与缓存
           ========================================================== */

        // 剧本与章节索引数据
        let scriptData = [];
        let chaptersData = [];
        let echoData = [];

        // 当前章节元数据（来自 chapters.csv 对应行）
        let currentChapterMeta = null;

        // 当前剧本指针（scriptData 的索引）
        let currentIndex = -1;

        // 打字机计时器
        let typeWriterTimer = null;

        // 运行状态
        let isGameStarted = false;   // 是否进入剧情推进
        let isChapterCover = false;  // 是否停留在章节封面页
        let isEchoMode = false;      // 是否在回响页
        let currentEchoIndex = 0;    // 回响页当前条目索引
        let echoSource = 'start';    // 回响页从哪里打开（start/end）

        // 渲染缓存：避免重复切换造成闪烁
        let currentBgUrl = "";
        let activeBgIndex = 1;

        let currentAvatarUrl = "";
        let activeAvatarIndex = 1;

        /* ==========================================================
           B) DOM 引用
           ========================================================== */

        // 背景层
        const bgLayer1 = document.getElementById('bg-layer-1');
        const bgLayer2 = document.getElementById('bg-layer-2');

        // 立绘层
        const charEl = document.getElementById('character-layer');

        // 右上角返回按钮
        const homeBtn = document.getElementById('home-btn');

        // 对话 UI
        const uiContainer = document.getElementById('ui-container');
        const avatar1 = document.getElementById('avatar-1');
        const avatar2 = document.getElementById('avatar-2');
        const textBoxEl = document.getElementById('text-box');
        const nameEl = document.getElementById('name-tag');
        const textEl = document.getElementById('dialog-text');

        // 音频
        const audioPlayer = document.getElementById('bgm-player');
        const voicePlayer = document.getElementById('voice-player');

        // 首页
        const startScreen = document.getElementById('start-screen');
        const startBgLayer = document.getElementById('start-bg-layer');
        const startTitle = document.getElementById('start-title');
        const chapterListContainer = document.getElementById('chapter-list-container');

        // 章节封面
        const chapterCoverScreen = document.getElementById('chapter-cover-screen');
        const chapterCoverBg = document.getElementById('chapter-cover-bg');
        const chapterCoverTitle = document.getElementById('chapter-cover-title');
        const chapterCoverSubtitle = document.getElementById('chapter-cover-subtitle');

        // 结尾页
        const endScreen = document.getElementById('end-screen');
        const endBgLayer = document.getElementById('end-bg-layer');
        const endTitleEl = document.getElementById('end-title');
        const endSubtitleEl = document.getElementById('end-subtitle');

        // 回响页
        const echoScreen = document.getElementById('echo-screen');
        const echoVisual = document.getElementById('echo-visual');
        const echoText = document.getElementById('echo-text');

        /* ==========================================================
           C) 初始化与输入控制
           ========================================================== */

        window.onload = function() {
            // 先加载章节索引，再渲染菜单
            loadChapters();

            // 回响数据独立加载，不影响主流程
            loadEchoes();

            // 键盘控制（剧情推进/封面页进入/回响页翻页）
            document.addEventListener('keydown', handleKeyPress);

            // 通过一次点击触发音频上下文（部分浏览器策略要求）
            document.addEventListener('click', initAudioContext, { once: true });
        };

        function initAudioContext() {
            if (audioPlayer.paused && audioPlayer.src) {
                audioPlayer.play().catch(() => {});
            }
        }

        function handleKeyPress(e) {
            // 在剧情模式下，方向键用于推进/回退；避免页面滚动
            if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.code)) {
                if (!isGameStarted)
                e.preventDefault();
            }

            // 回响页：Esc 退出，左右切换
            if (isEchoMode) {
                if (e.key === 'Escape') closeEchoMode();
                if (e.key === 'ArrowRight') changeEcho(1);
                if (e.key === 'ArrowLeft') changeEcho(-1);
                return;
            }

            // 章节封面页：Enter/空格/右/下进入剧情；Esc 返回首页
            if (isChapterCover) {
                const startKeys = ['ArrowRight', 'ArrowDown', ' ', 'Enter'];
                if (e.key === 'Escape') returnToTitle();
                if (startKeys.includes(e.key)) startChapterFromCover();
                return;
            }

            // 剧情模式：右/下/空格/Enter 前进；左/上 后退
            const nextKeys = ['ArrowRight', 'ArrowDown', ' ', 'Enter'];
            const prevKeys = ['ArrowLeft', 'ArrowUp'];

            if (!isGameStarted) return;

            if (nextKeys.includes(e.key)) nextStep();
            else if (prevKeys.includes(e.key)) prevStep();
        }

        /* ==========================================================
           D) 数据加载（chapters.csv / 剧本 CSV / echoes.csv）
           ========================================================== */

        function loadChapters() {
            fetch('chapters.csv')
                .then(res => res.ok ? res.text() : Promise.reject("chapters.csv 404"))
                .then(text => {
                    chaptersData = parseChaptersCSV(text);
                    validateChaptersDataOrThrow(chaptersData);
                    renderChapterMenu();
                })
                .catch(err => {
                    console.error(err);
                    chapterListContainer.innerHTML = `<div style="color:red">无法读取记忆索引 (chapters.csv)</div>`;
                });
        }

        function loadScriptAndStart(chapter) {
            currentChapterMeta = chapter;

            const scriptFile = requireField(chapter, 'file', '章节配置');
            startTitle.innerText = "读取中...";
            console.log("正在尝试加载:", scriptFile);

            fetch(scriptFile)
                .then(res => res.ok ? res.text() : Promise.reject(new Error(`文件未找到 (404): ${scriptFile}`)))
                .then(text => {
                    scriptData = parseScriptCSV(text);
                    validateScriptDataOrThrow(scriptData, requireField(chapter, 'title', '章节配置'));
                    showChapterCover();
                })
                .catch(err => {
                    console.error(err);
                    if (String(err && err.message || '').includes("Failed to fetch")) {
                        alert(`读取失败：浏览器禁止直接读取本地文件。\n请尝试使用 VS Code Live Server 或 Firefox 运行。`);
                    } else {
                        alert(`读取失败：${err.message || err}`);
                    }
                    // 回退显示首页标题
                    startTitle.innerText = requireField(chaptersData[0], 'game_title', '索引页配置(第1行)');
                });
        }

        function loadEchoes() {
            fetch('echoes.csv')
                .then(res => res.ok ? res.text() : Promise.reject("echoes.csv 404"))
                .then(text => { echoData = parseEchoCSV(text); })
                .catch(() => { echoData = []; });
        }

        /* ==========================================================
           E) CSV 解析与校验
           ========================================================== */

        // 剧本 CSV：第 1 行为表头，后续每行：type,bg,char,avatar,name,text...
        function parseScriptCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const result = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const parts = line.split(',');
                result.push({
                    type: parts[0] ? parts[0].trim() : "",
                    bg: (parts[1] || "").replace(/\\/g, '/').trim(),
                    char: (parts[2] || "").replace(/\\/g, '/').trim(),
                    avatar: (parts[3] || "").replace(/\\/g, '/').trim(),
                    name: (parts[4] || "").trim(),
                    text: (parts.slice(5).join(',') || "").trim()
                });
            }
            return result;
        }

        // chapters.csv：表头键名由文件决定，解析为对象数组
        function parseChaptersCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) throw new Error("chapters.csv 内容为空或缺少数据行");

            const headers = lines[0].split(',').map(h => h.trim());
            const result = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const parts = line.split(',').map(p => p.trim());
                const row = {};
                headers.forEach((h, idx) => {
                    row[h] = (parts[idx] || "").replace(/\\/g, '/').trim();
                });
                result.push(row);
            }
            return result;
        }

        // echoes.csv：img,text,voice（表头行可选）
        function parseEchoCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const result = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line || line.startsWith('img')) continue;

                const parts = line.split(',');
                result.push({
                    img: (parts[0] || "").replace(/\\/g, '/').trim(),
                    text: (parts[1] || "..."),
                    voice: (parts[2] || "").replace(/\\/g, '/').trim()
                });
            }
            return result;
        }

        // 必填字段读取：缺失时抛错，方便定位到 chapters.csv 的哪一行哪一列
        function requireField(obj, field, context) {
            if (!obj || typeof obj !== 'object') throw new Error(`数据错误：${context} 不是对象`);
            if (!(field in obj)) throw new Error(`chapters.csv 缺少列：${field}`);
            if (!obj[field] || obj[field].trim() === "") throw new Error(`chapters.csv 字段为空：${field}（${context}）`);
            return obj[field].trim();
        }

        // chapters.csv 的完整性校验
        function validateChaptersDataOrThrow(chapters) {
            if (!Array.isArray(chapters) || chapters.length === 0) throw new Error("chapters.csv 未提供任何章节");

            // 第 1 行用于索引页配置
            requireField(chapters[0], 'game_title', '索引页配置(第1行)');
            requireField(chapters[0], 'index_bg', '索引页配置(第1行)');
            requireField(chapters[0], 'index_bgm', '索引页配置(第1行)');

            // 每个章节必填字段
            chapters.forEach((c, i) => {
                const ctx = `第${i+1}行章节`;
                requireField(c, 'title', ctx);
                requireField(c, 'subtitle', ctx);
                requireField(c, 'file', ctx);
                requireField(c, 'cover_bg', ctx);
                requireField(c, 'bgm', ctx);
                requireField(c, 'end_bg', ctx);
                requireField(c, 'end_text', ctx);
            });
        }

        // 剧本校验：start/end 行仅用于标记，不允许携带多余字段
        function validateScriptDataOrThrow(script, chapterTitle) {
            if (!Array.isArray(script) || script.length === 0) throw new Error(`剧本为空：${chapterTitle}`);

            script.forEach((row, idx) => {
                const t = (row.type || '').trim();
                if (t === 'start' || t === 'end') {
                    const bad = ['bg','char','avatar','name','text'].some(k => row[k] && row[k].trim() !== "");
                    if (bad) {
                        throw new Error(`剧本第${idx+2}行（${t}）不允许定义封面/结束页等内容，请在 chapters.csv 中定义（章节：${chapterTitle}）`);
                    }
                }
            });
        }

        /* ==========================================================
           F) 首页章节菜单渲染
           ========================================================== */

        function renderChapterMenu() {
            chapterListContainer.innerHTML = "";

            if (chaptersData.length === 0) {
                chapterListContainer.innerHTML = "暂无章节";
                return;
            }

            // 索引页配置（取第 1 行）
            const indexTitle = requireField(chaptersData[0], 'game_title', '索引页配置(第1行)');
            const indexBg = requireField(chaptersData[0], 'index_bg', '索引页配置(第1行)');
            const indexBgm = requireField(chaptersData[0], 'index_bgm', '索引页配置(第1行)');

            startTitle.innerText = indexTitle;
            startBgLayer.style.backgroundImage = `url('${indexBg}')`;

            // 背景音乐：若已是同一首则不重复设置
            if (audioPlayer.src.indexOf(indexBgm) === -1) {
                audioPlayer.src = indexBgm;
                audioPlayer.volume = 0.5;
            }

            // 章节卡片（包含索引页配置行时，也会被渲染；可按需在 chapters.csv 自行拆分）
            chaptersData.forEach((chapter, index) => {
                const card = document.createElement('div');
                card.className = 'chapter-card';
                card.onclick = () => loadScriptAndStart(chapter);

                const infoDiv = document.createElement('div');

                const titleDiv = document.createElement('div');
                titleDiv.className = 'chapter-title';
                titleDiv.innerText = requireField(chapter, 'title', `第${index+1}行章节`);

                const subDiv = document.createElement('div');
                subDiv.className = 'chapter-subtitle';
                subDiv.innerText = requireField(chapter, 'subtitle', `第${index+1}行章节`);

                infoDiv.appendChild(titleDiv);
                infoDiv.appendChild(subDiv);

                const arrow = document.createElement('div');
                arrow.className = 'chapter-arrow';
                arrow.innerText = '▶';

                card.appendChild(infoDiv);
                card.appendChild(arrow);
                chapterListContainer.appendChild(card);
            });
        }

        /* ==========================================================
           G) 章节封面 / 剧情流程
           ========================================================== */

        function showChapterCover() {
            const chapterTitle = currentChapterMeta ? requireField(currentChapterMeta, 'title', '当前章节') : '未知章节';
            const chapterSubtitle = currentChapterMeta ? requireField(currentChapterMeta, 'subtitle', chapterTitle) : '';
            const chapterBgm = requireField(currentChapterMeta, 'bgm', chapterTitle);
            const chapterCover = requireField(currentChapterMeta, 'cover_bg', chapterTitle);

            // 切换本章 BGM
            if (audioPlayer.src.indexOf(chapterBgm) === -1) {
                audioPlayer.src = chapterBgm;
                audioPlayer.volume = 0.5;
            }
            audioPlayer.play().catch(() => {});

            // 封面视觉与文字
            chapterCoverBg.style.backgroundImage = `url('${chapterCover}')`;
            chapterCoverTitle.innerText = chapterTitle;
            chapterCoverSubtitle.innerText = chapterSubtitle;

            // 首页淡出、封面淡入
            startScreen.style.opacity = 0;
            setTimeout(() => { startScreen.style.display = 'none'; }, 500);

            chapterCoverScreen.style.display = 'flex';
            setTimeout(() => { chapterCoverScreen.style.opacity = 1; }, 50);

            // 状态标记
            isChapterCover = true;
            isGameStarted = false;

            // 右上角返回按钮在封面页可用
            homeBtn.style.display = 'block';
        }

        function startChapterFromCover() {
            if (!isChapterCover) return;
            startGameLogic();
        }

        function startGameLogic() {
            if (isGameStarted) return;

            // 进入剧情时，背景先切到封面图（与章节封面保持一致）
            const chapterTitle = currentChapterMeta ? requireField(currentChapterMeta, 'title', '当前章节') : '未知章节';
            const chapterCover = requireField(currentChapterMeta, 'cover_bg', chapterTitle);

            switchBackground(chapterCover);
            currentBgUrl = chapterCover;

            // 关闭封面页
            isGameStarted = true;
            isChapterCover = false;

            chapterCoverScreen.style.opacity = 0;
            setTimeout(() => { chapterCoverScreen.style.display = 'none'; }, 500);

            // 打开对话 UI
            uiContainer.style.display = 'block';
            homeBtn.style.display = 'block';

            // 从第一条有效对白开始（跳过 start/end 行）
            currentIndex = -1;
            const firstDialogIndex = scriptData.findIndex(s => s.type !== 'start' && s.type !== 'end');
            if (firstDialogIndex !== -1) {
                currentIndex = firstDialogIndex;
                renderSceneState(currentIndex);
            }
        }

        function nextStep() {
            if (!isGameStarted) return;

            // 若当前位置已是 end 行，则不再推进
            if (currentIndex >= 0 && scriptData[currentIndex] && scriptData[currentIndex].type === 'end') return;

            const nextIndex = currentIndex + 1;
            if (nextIndex >= scriptData.length) return;

            currentIndex = nextIndex;
            const scene = scriptData[currentIndex];

            // end 行触发章节结尾页
            if (scene.type === 'end') {
                showEnding();
                return;
            }

            // start 行自动跳过
            if (scene.type === 'start') {
                nextStep();
                return;
            }

            // 普通对白渲染
            renderSceneState(currentIndex);
        }

        function prevStep() {
            if (!isGameStarted) return;

            // 向前寻找上一条对白（跳过 start 行）
            let targetIndex = currentIndex - 1;
            while (targetIndex >= 0 && scriptData[targetIndex].type === 'start') targetIndex--;

            if (targetIndex < 0) return;

            // 若结尾页正在显示，则先关掉并回到对话 UI
            if (endScreen.style.display === 'flex') {
                endScreen.style.opacity = 0;
                setTimeout(() => { endScreen.style.display = 'none'; }, 500);
                uiContainer.style.display = 'block';
                homeBtn.style.display = 'block';
            }

            currentIndex = targetIndex;
            renderSceneState(currentIndex);
        }

        function renderSceneState(index) {
            const scene = scriptData[index];

            // 背景：向上回溯，找到最近一次设置 bg 的条目
            let effectiveBg = "";
            for (let i = index; i >= 0; i--) {
                if (scriptData[i].bg && scriptData[i].bg !== "") {
                    effectiveBg = scriptData[i].bg;
                    break;
                }
            }
            if (effectiveBg && effectiveBg !== currentBgUrl) {
                switchBackground(effectiveBg);
                currentBgUrl = effectiveBg;
            }

            // 头像：以当前行 avatar 为准
            const effectiveAvatar = scene.avatar || "";
            if (effectiveAvatar !== currentAvatarUrl) {
                switchAvatar(effectiveAvatar);
                currentAvatarUrl = effectiveAvatar;
            }

            // 立绘：有则显示，无则隐藏
            if (scene.char && scene.char !== "") {
                charEl.style.backgroundImage = `url('${scene.char}')`;
                charEl.style.opacity = 1;
            } else {
                charEl.style.opacity = 0;
            }

            // 对话框内容
            textBoxEl.style.opacity = "1";
            nameEl.innerText = scene.name || "";
            runTypewriter(scene.text);
        }

        function showEnding() {
            // 关掉剧情 UI
            uiContainer.style.display = 'none';
            chapterCoverScreen.style.display = 'none';
            chapterCoverScreen.style.opacity = 0;
            homeBtn.style.display = 'none';

            // 清空立绘
            charEl.style.opacity = 0;

            // 读取结尾页配置
            const chapterTitle = currentChapterMeta ? requireField(currentChapterMeta, 'title', '当前章节') : '未知章节';
            const endBg = requireField(currentChapterMeta, 'end_bg', chapterTitle);
            const endText = requireField(currentChapterMeta, 'end_text', chapterTitle);

            // 设置结尾页视觉与文字
            endBgLayer.style.backgroundImage = `url('${endBg}')`;
            endTitleEl.innerText = chapterTitle;
            endSubtitleEl.innerText = endText;

            // 显示结尾页
            endScreen.style.display = 'flex';
            setTimeout(() => { endScreen.style.opacity = 1; }, 50);
        }

        function restartCurrentChapter() {
            // 没有章节上下文时直接回首页
            if (!currentChapterMeta || !Array.isArray(scriptData) || scriptData.length === 0) {
                returnToTitle();
                return;
            }

            // 关结尾页
            endScreen.style.opacity = 0;
            setTimeout(() => { endScreen.style.display = 'none'; }, 500);

            // 复位进度与状态
            isGameStarted = false;
            isChapterCover = false;
            currentIndex = -1;

            // 打开对话 UI 与右上角按钮
            uiContainer.style.display = 'block';
            homeBtn.style.display = 'block';

            // 保障 BGM 为本章
            const chapterTitle = requireField(currentChapterMeta, 'title', '当前章节');
            const chapterBgm = requireField(currentChapterMeta, 'bgm', chapterTitle);
            if (audioPlayer.src.indexOf(chapterBgm) === -1) {
                audioPlayer.src = chapterBgm;
                audioPlayer.volume = 0.5;
            }
            audioPlayer.play().catch(() => {});

            // 背景回到本章封面图
            const chapterCover = requireField(currentChapterMeta, 'cover_bg', chapterTitle);
            switchBackground(chapterCover);
            currentBgUrl = chapterCover;

            // 清空立绘与头像
            charEl.style.opacity = 0;
            switchAvatar("");
            currentAvatarUrl = "";

            // 直接进入剧情首句
            isGameStarted = true;
            const firstDialogIndex = scriptData.findIndex(s => s.type !== 'start' && s.type !== 'end');
            if (firstDialogIndex !== -1) {
                currentIndex = firstDialogIndex;
                renderSceneState(currentIndex);
            }
        }

        function returnToTitle() {
            // 主状态复位
            isGameStarted = false;
            isChapterCover = false;

            // 关闭所有剧情相关层
            uiContainer.style.display = 'none';

            chapterCoverScreen.style.display = 'none';
            chapterCoverScreen.style.opacity = 0;

            endScreen.style.display = 'none';
            endScreen.style.opacity = 0;

            echoScreen.style.display = 'none';

            // 右上角按钮隐藏
            homeBtn.style.display = 'none';

            // 清空立绘与头像
            charEl.style.opacity = 0;
            switchAvatar("");
            currentAvatarUrl = "";

            // 打开首页并刷新菜单/标题/背景音乐
            startScreen.style.display = 'flex';
            startTitle.innerText = requireField(chaptersData[0], 'game_title', '索引页配置(第1行)');
            renderChapterMenu();

            setTimeout(() => {
                startScreen.style.opacity = 1;
            }, 50);
        }

        /* ==========================================================
           H) 回响页（Echo Mode）
           ========================================================== */

        function openEchoMode(source = 'start') {
            if (echoData.length === 0) {
                alert("未找到回想数据");
                return;
            }

            echoSource = source;
            isEchoMode = true;
            currentEchoIndex = 0;

            // 从不同页面进入回响页时，需要隐藏对应页面
            if (echoSource === 'start') {
                startScreen.style.display = 'none';
            } else if (echoSource === 'end') {
                endScreen.style.display = 'none';
            }

            echoScreen.style.display = 'flex';
            renderEcho(currentEchoIndex);
        }

        function closeEchoMode() {
            isEchoMode = false;

            // 关闭语音
            voicePlayer.pause();

            // 隐藏回响页
            echoScreen.style.display = 'none';

            // 返回原页面
            if (echoSource === 'end') {
                endScreen.style.display = 'flex';
                endScreen.style.opacity = 1;
            } else {
                startScreen.style.display = 'flex';
                startScreen.style.opacity = 1;
            }
        }

        function changeEcho(direction) {
            if (echoData.length === 0) return;

            const total = echoData.length;
            let newIndex = currentEchoIndex + direction;

            // 环形切换
            if (newIndex < 0) newIndex = total - 1;
            if (newIndex >= total) newIndex = 0;

            currentEchoIndex = newIndex;
            renderEcho(currentEchoIndex);
        }

        function renderEcho(index) {
            const data = echoData[index];

            // 画面
            if (data.img) echoVisual.style.backgroundImage = `url('${data.img}')`;
            else echoVisual.style.backgroundImage = 'none';

            // 文本
            echoText.innerText = data.text || "";

            // 语音
            if (data.voice) {
                voicePlayer.src = data.voice;
                voicePlayer.play().catch(() => {});
            } else {
                voicePlayer.pause();
            }
        }

        /* ==========================================================
           I) 渲染辅助：背景/头像/打字机
           ========================================================== */

        function switchBackground(url) {
            if (!url) return;

            const activeLayer = activeBgIndex === 1 ? bgLayer1 : bgLayer2;
            const nextLayer = activeBgIndex === 1 ? bgLayer2 : bgLayer1;

            nextLayer.style.backgroundImage = `url('${url}')`;
            nextLayer.classList.add('active');
            activeLayer.classList.remove('active');

            activeBgIndex = (activeBgIndex === 1) ? 2 : 1;
        }

        function switchAvatar(url) {
            const activeEl = (activeAvatarIndex === 1) ? avatar1 : avatar2;
            const nextEl = (activeAvatarIndex === 1) ? avatar2 : avatar1;

            // 传空则清空两层头像
            if (!url) {
                activeEl.classList.remove('active');
                nextEl.classList.remove('active');

                setTimeout(() => {
                    activeEl.src = "";
                    nextEl.src = "";
                }, 500);

                return;
            }

            // 交替加载，形成淡入淡出
            nextEl.src = url;
            nextEl.classList.add('active');
            activeEl.classList.remove('active');

            activeAvatarIndex = (activeAvatarIndex === 1) ? 2 : 1;
        }

        function runTypewriter(text) {
            textEl.innerText = "";

            if (typeWriterTimer) clearInterval(typeWriterTimer);

            let i = 0;
            const content = text ? text.replace(/^"|"$/g, '') : "";

            typeWriterTimer = setInterval(() => {
                if (i < content.length) {
                    textEl.innerText += content.charAt(i);
                    i++;
                } else {
                    clearInterval(typeWriterTimer);
                }
            }, 30);
        }
    </script>
</body>
</html>
